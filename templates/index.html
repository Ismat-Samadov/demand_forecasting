<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Demand Forecasting Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü§ñ AI Demand Forecasting System</h1>
            <p>Improving accuracy and reducing supply chain costs with machine learning</p>
        </header>

        <div class="dashboard">
            <!-- Model Performance Section -->
            <div class="card">
                <h2>üìä Model Performance</h2>
                <div class="metrics-grid">
                    {% if model_scores %}
                        {% for model_name, metrics in model_scores.items() %}
                        <div class="metric-card">
                            <h3>{{ model_name.upper() }}</h3>
                            <div class="metric">
                                <span class="metric-label">MAE:</span>
                                <span class="metric-value">{{ "%.4f"|format(metrics.mae) }}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">RMSE:</span>
                                <span class="metric-value">{{ "%.4f"|format(metrics.rmse) }}</span>
                            </div>
                            {% if model_name == best_model %}
                            <div class="best-model-badge">‚úÖ Best Model</div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    {% else %}
                    <p>No model performance data available. Train a model first.</p>
                    {% endif %}
                </div>
            </div>

            <!-- Prediction Form -->
            <div class="card">
                <h2>üîÆ Demand Prediction</h2>
                <p class="form-description">Enter product and store details to predict daily sales quantity</p>
                
                <form id="predictionForm">
                    <div class="form-grid">
                        <!-- Product Information -->
                        <div class="form-section">
                            <h4>üì¶ Product Information</h4>
                            <div class="form-group">
                                <label for="item_id">Product ID <span class="required">*</span></label>
                                <input type="text" id="item_id" name="item_id" required 
                                       value="HOBBIES_1_001"
                                       placeholder="e.g., HOBBIES_1_001, HOUSEHOLD_1_118, FOODS_3_555"
                                       pattern="[A-Z_0-9]+"
                                       title="Product ID (letters, numbers, underscores only)">
                                <small>Enter the specific product identifier</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="dept_id">Department <span class="required">*</span></label>
                                <select id="dept_id" name="dept_id" required>
                                    <option value="">Select Department</option>
                                    <optgroup label="Hobbies">
                                        <option value="HOBBIES_1" selected>HOBBIES_1 - Games & Toys</option>
                                        <option value="HOBBIES_2">HOBBIES_2 - Arts & Crafts</option>
                                    </optgroup>
                                    <optgroup label="Household">
                                        <option value="HOUSEHOLD_1">HOUSEHOLD_1 - Cleaning & Storage</option>
                                        <option value="HOUSEHOLD_2">HOUSEHOLD_2 - Personal Care</option>
                                    </optgroup>
                                    <optgroup label="Foods">
                                        <option value="FOODS_1">FOODS_1 - Packaged Foods</option>
                                        <option value="FOODS_2">FOODS_2 - Fresh Foods</option>
                                        <option value="FOODS_3">FOODS_3 - Beverages</option>
                                    </optgroup>
                                </select>
                                <small>Product category affects demand patterns</small>
                            </div>
                        </div>

                        <!-- Store Information -->
                        <div class="form-section">
                            <h4>üè™ Store Information</h4>
                            <div class="form-group">
                                <label for="store_id">Store Location <span class="required">*</span></label>
                                <select id="store_id" name="store_id" required>
                                    <option value="">Select Store</option>
                                    <optgroup label="California Stores">
                                        <option value="CA_1" selected>CA_1 - California Store 1</option>
                                        <option value="CA_2">CA_2 - California Store 2</option>
                                        <option value="CA_3">CA_3 - California Store 3</option>
                                        <option value="CA_4">CA_4 - California Store 4</option>
                                    </optgroup>
                                    <optgroup label="Texas Stores">
                                        <option value="TX_1">TX_1 - Texas Store 1</option>
                                        <option value="TX_2">TX_2 - Texas Store 2</option>
                                        <option value="TX_3">TX_3 - Texas Store 3</option>
                                    </optgroup>
                                    <optgroup label="Wisconsin Stores">
                                        <option value="WI_1">WI_1 - Wisconsin Store 1</option>
                                        <option value="WI_2">WI_2 - Wisconsin Store 2</option>
                                        <option value="WI_3">WI_3 - Wisconsin Store 3</option>
                                    </optgroup>
                                </select>
                                <small>Different stores have different demand patterns</small>
                            </div>
                        </div>

                        <!-- Price Information -->
                        <div class="form-section">
                            <h4>üí∞ Pricing Information</h4>
                            <div class="form-group">
                                <label for="sell_price">Current Selling Price <span class="required">*</span></label>
                                <div class="input-with-currency">
                                    <span class="currency-symbol">$</span>
                                    <input type="number" id="sell_price" name="sell_price" 
                                           step="0.01" min="0.01" max="1000" required 
                                           value="9.99"
                                           placeholder="9.99">
                                </div>
                                <small>Price significantly affects demand - enter current retail price</small>
                            </div>
                        </div>

                        <!-- Time Information -->
                        <div class="form-section">
                            <h4>üìÖ Prediction Date</h4>
                            <div class="form-group">
                                <label for="prediction_date">Date to Predict <span class="required">*</span></label>
                                <input type="date" id="prediction_date" name="prediction_date" required value="2024-07-15">
                                <small>Select a future date for demand prediction</small>
                            </div>
                        </div>

                        <!-- Event Information -->
                        <div class="form-section">
                            <h4>üéâ Special Events</h4>
                            <div class="form-group checkbox-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="has_event" name="has_event">
                                    <span class="checkmark"></span>
                                    Special Event Day
                                </label>
                                <small>Check if the prediction date has special events (holidays, sports, etc.)</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="clearForm()">üîÑ Clear Form</button>
                        <button type="submit" class="btn-primary">üöÄ Predict Demand</button>
                    </div>
                </form>
                
                <div id="predictionResult" class="prediction-result" style="display: none;">
                    <div class="result-header">
                        <h3>üìä Prediction Result</h3>
                        <div class="confidence-badge" id="confidenceBadge">High Confidence</div>
                    </div>
                    
                    <div class="result-main">
                        <div class="result-display">
                            <span class="result-label">Predicted Daily Sales:</span>
                            <span id="predictedValue" class="result-value">0</span>
                            <span class="result-unit">units</span>
                        </div>
                        
                        <div class="result-context" id="resultContext">
                            <div class="context-item">
                                <span class="context-label">Business Impact:</span>
                                <span id="businessImpact" class="context-value">Optimal inventory level</span>
                            </div>
                            <div class="context-item">
                                <span class="context-label">Recommendation:</span>
                                <span id="recommendation" class="context-value">Stock according to prediction</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="result-details">
                        <h4>üìã Prediction Details</h4>
                        <div class="details-grid" id="predictionDetails">
                            <!-- Will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Feature Importance -->
            <div class="card">
                <h2>üéØ Feature Importance</h2>
                {% if feature_importance is not none %}
                <div class="importance-chart">
                    <canvas id="importanceChart"></canvas>
                </div>
                <div class="importance-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Feature</th>
                                <th>Importance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for idx, row in feature_importance.iterrows() %}
                            <tr>
                                <td>{{ loop.index }}</td>
                                <td>{{ row.feature }}</td>
                                <td>{{ "%.4f"|format(row.importance) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p>Feature importance data not available. Train a tree-based model first.</p>
                {% endif %}
            </div>

            <!-- Data Insights -->
            <div class="card">
                <h2>üìà Data Insights</h2>
                <div class="insights-grid">
                    <div class="insight-item">
                        <h4>Total Products</h4>
                        <span class="insight-number">{{ data_stats.total_products if data_stats else 'N/A' }}</span>
                    </div>
                    <div class="insight-item">
                        <h4>Total Stores</h4>
                        <span class="insight-number">{{ data_stats.total_stores if data_stats else 'N/A' }}</span>
                    </div>
                    <div class="insight-item">
                        <h4>Date Range</h4>
                        <span class="insight-number">{{ data_stats.date_range if data_stats else 'N/A' }}</span>
                    </div>
                    <div class="insight-item">
                        <h4>Avg Daily Sales</h4>
                        <span class="insight-number">{{ data_stats.avg_daily_sales if data_stats else 'N/A' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <footer>
            <p>üî¨ Built with AI for Supply Chain Optimization | Reducing costs through accurate demand prediction</p>
        </footer>
    </div>

    <script src="/static/app.js"></script>
    
    {% if feature_importance is not none %}
    <script>
        // Feature Importance Chart
        const ctx = document.getElementById('importanceChart').getContext('2d');
        const importanceData = {{ feature_importance.to_dict('records')|tojson|safe }};
        
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: importanceData.slice(0, 10).map(function(item) { return item.feature; }),
                datasets: [{
                    label: 'Feature Importance',
                    data: importanceData.slice(0, 10).map(function(item) { return item.importance; }),
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                scales: {
                    x: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Top 10 Most Important Features'
                    }
                }
            }
        });
    </script>
    {% endif %}
</body>
</html>